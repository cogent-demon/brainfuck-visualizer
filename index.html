<!DOCTYPE html>
<html>
<head>
    <title>Brainfuck Visualizer</title>
    <link rel="stylesheet" href="media/css/screen.css" />
    <script type="text/javascript" src="media/js/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="media/js/underscore-min.js"></script>
    <script type="text/javascript" src="media/js/backbone-min.js"></script>
</head>
<body>

    <header>

    </header>

    <section class="machine">
        <ul class="tape">
        </ul>
        <div class="pointer"><em></em></div>
    </section>

    <section class="editor">
        <textarea id="source" cols="30" rows="10">
+++++ +++++             initialize counter (cell #0) to 10
[                       use loop to set the next four cells to 70/100/30/10
    > +++++ ++              add  7 to cell #1
    > +++++ +++++           add 10 to cell #2
    > +++                   add  3 to cell #3
    > +                     add  1 to cell #4
    <<<< -                  decrement counter (cell #0)
]
> ++ .                  print 'H'
> + .                   print 'e'
+++++ ++ .              print 'l'
.                       print 'l'
+++ .                   print 'o'
> ++ .                  print ' '
<< +++++ +++++ +++++ .  print 'W'
> .                     print 'o'
+++ .                   print 'r'
----- - .               print 'l'
----- --- .             print 'd'
> + .                   print '!'
> .                     print '\n'
        </textarea>
    </section>

    <script type="text/javascript">
        var Cell = Backbone.Model.extend({
            defaults: {
                value: 0
            },
            inc: function () {
                this.set("value", this.get("value") + 1);
            },
            dec: function () {
                this.set("value", this.get("value") - 1);
            }
        });
        var Tape = Backbone.Collection.extend({
            model: Cell
        });
        var Pointer = Backbone.Model.extend({
            defaults: {
                index: 0
            },
            left: function () {
                this.set("index", this.get("index") - 1);
            },
            right: function () {
                this.set("index", this.get("index") + 1);
            }
        });
        var CellView = Backbone.View.extend({
            tagName: "li",
            initialize: function () {
                this.model.on('change', this.render, this);
            },
            render: function () {
                this.$el.html(this.model.get("value"));
                return this;
            }
        });

        var PointerView = Backbone.View.extend({
            el: "div.pointer",
            initialize: function () {
                this.model.on("change", this.render, this);
            },
            render: function () {
                this.$el.animate({
                    "margin-left": this.model.get("index") * this.$el.width()
                }, 100);
                return this;
            }
        });

        var TapeView = Backbone.View.extend({
            el: $("ul.tape"),
            render: function () {
                _.forEach(this.model.models, function (model) {
                    this.$el.append((new CellView({
                        model: model
                    })).render().el);
                }, this);

                new PointerView({
                    model: this.options.pointer
                }).render();
                return this;
            }
        });

        var Interpreter = function (source, tape, pointer) {
            var tokens = source.replace(/[^<>+-.,\[\]]/g, ''),
                    jumps = [],
                    action = 0;
            this.next = function () {
                if (action > tokens.length) throw {
                    "name": "End",
                    "message": "End of brainfuck script."
                };
                var token = tokens[action];
                var cell = tape.models[pointer.get("index")];
                if (token == "<") {
                    pointer.left();
                } else if (token == ">") {
                    pointer.right();
                } else if (token == "-") {
                    cell.dec();
                } else if (token == "+") {
                    cell.inc();
                } else if (token == ",") {
                } else if (token == ".") {
                    console.log(String.fromCharCode(cell.get('value')));
                } else if (token == "[") {
                    jumps.push(action)
                } else if (token == "]") {
                    if (cell.get("value") > 0) {
                        action = jumps[jumps.length-1];
                    } else {
                        jumps.pop();
                    }
                }
                action++;
            }
        };

        $(function () {
            var tape = new Tape(_.times(27, $.noop));
            var pointer = new Pointer();

            new TapeView({
                model: tape,
                pointer: pointer
            }).render();

            var interpreter = new Interpreter($("#source").val(), tape, pointer);

            var next = setInterval(function () {
                try {
                    interpreter.next()
                } catch (e) {
                    clearInterval(next);
                }
            }, 70);

        });
    </script>
</body>
</html>